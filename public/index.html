<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
	<link rel="stylesheet" href="themes/simplecozy.css" type="text/css" media="screen" />
	<script type="text/javascript"
        src="//ajax.googleapis.com/ajax/libs/angularjs/1.0.7/angular.min.js"></script>
	<script src="core.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>

        <title>AutoCrest</title>
    </head>
    <body ng-app="autocrest">

	<div ng-controller="ErrorController" >
        <h1>AutoCrest</h1><h1>
        Mon Nov 24 18:37:24 PST 2014
        </h1></div>

	<div id="resultsForm" ng-show="showForm()" ng-controller="ResultsController">
		<h1>Plate Number: {{results.plate_number}}</h1>
	</div>

	<div id="entryForm" ng-show="showForm()" ng-controller="FormController">
	<br>
    	<form novalidate class="simple-form">
		<input name="address" ng-model="user.address" placeholder="Enter location/address">
		<input name="plate_number" ng-model="user.plate_number" placeholder="Enter license plate number">
		<div ng-controller="PhoneController" ><font color="red">{{error}}</font></div>
		<input name="phone_number" ng-model="user.phone_number"  placeholder="Enter phone number">
		<input name="price" ng-model="user.price"  placeholder="Enter price">
        <button onclick="sell(this.form)">Sell Parking Spot</button>
        <button onclick="buy(this.form)">Buy Parking Spot</button>
        </form>
	<!--
        <pre>form = {{user | json}}</pre>
        <pre>master = {{master | json}}</pre>
	-->
	<br>
        <p>
	Looking for parking close to where you are? This spot is for you.
        </p>
        <p>
	Advertise or buy parking. Choose one. All transactions are to be negotiated between the parker and parkee. AutoCrest is not responsible for guarantee of parking spots, payment, or liability resulting from this sites use.
        </p>
        </div>

<script src="/socket.io/socket.io.js"></script>
<script>
function PhoneController($scope){
    $scope.error='';
}

function ResultsController($scope){

    $scope.setResults = function (data){ 
	console.log("setResults: [" + data.plate_number + "]");
        $scope.results = {};
        $scope.results.plate_number = data.plate_number;
    }

    $scope.showForm = function (res){ 
	defaultValue=false;
	if(res != undefined){
	    $scope.showForm.cached=res;
	    return res;
	}

	// res == undefined do we hae cached?
        if ($scope.showForm.cached == undefined){
	    return defaultValue;
        }
	return $scope.showForm.cached;
    } // END showForm()

}  // END ResultsController()

function FormController($scope){
    $scope.error='';

    $scope.showForm = function (res){ 
	defaultValue=true;
	if(res != undefined){
	    $scope.showForm.cached=res;
	    return res;
	}

	// res == undefined do we hae cached?
        if ($scope.showForm.cached == undefined){
	    return defaultValue;
        }

	return $scope.showForm.cached;
    } // END showForm()

} // END FormController()

    angular.module("autocrest", [])
    .controller("ErrorController", function($scope) {
    $scope.errorTo = {};
    $scope.errorTo.title = "World, AutoCrest";
    $scope.errorTo.phone = "*";
    });

  var socket = io.connect('http://localhost');

function transact(transaction, data){ 
    socket.emit("transaction", { 
        address: data.address.value,
        phone_number: data.phone_number.value,
        price: data.price.value, 
        plate_number: data.plate_number.value,
        request: transaction 
    }); // END socket.emit
}

function buy(data){ 
    transact("buy", data);
}

function sell(data){ 
    transact("sell", data);
}

function showForm(form, bool){
    var scope = angular.element( document.getElementById(form)).
    scope();
    scope.$apply(function () {
        scope.showForm(bool);
    });
}

socket.on('success', function (result) {
    showForm("entryForm", false);
    showForm("resultsForm", true);
    var scope = angular.element( document.getElementById("resultsForm")).
    scope();
    scope.$apply(function () {
        scope.setResults(result);
    });
    //console.log(scope);
});

socket.on('failed', function (data) {
    //io.sockets.emit('failed', { error: 'failed to validate' });
    console.log("failed");
    window.stop();
});

</script></body></html>

